/*! entboost messenger jquery plugin - v0.1.0 - 2015-08-21
* https://github.com/Administrator/jqEBMessenger
* Copyright (c) 2015 ; Licensed MIT */
!function(window,$){$.extend({eb_client_config:{default_header:"images/logo2.gif",opposite_head_img:"images/logo2.gif",my_head_img:"images/logo2.gif",url:"javascript:;",title:"",contact_img:"images/logo2.gif",mes_ring:{open:!0,sound_file:"css/msg.wav"},organize:{ent_icon:"images/company.png",group_icon:"images/group.png",member_icon:"images/logo2.gif"},cs:{init:function(){$.eb_client_config.title="客服中心",$.eb_client_config.default_header="images/cs.jpg",$.eb_client_config.opposite_head_img="images/cs.jpg",$.eb_client_config.my_head_img="images/logo2.gif",$.eb_client_config.url="http://www.entboost.com"}},common:{init:function(){}}}})}(window,jQuery),function(window,$){layer.use("extend/layer.ext.js");var eb_client_config=$.eb_client_config;Date.prototype.format=function(format){var o={"M+":this.getMonth()+1,"d+":this.getDate(),"h+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),S:this.getMilliseconds()};/(y+)/.test(format)&&(format=format.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length)));for(var k in o)new RegExp("("+k+")").test(format)&&(format=format.replace(RegExp.$1,1==RegExp.$1.length?o[k]:("00"+o[k]).substr((""+o[k]).length)));return format},$.extend({ebTemp:{}}),$.ebTemp.temps=function(){var obj={chat_win:'<div class="layim_chatbox" id="layim_chatbox"><h6><span class="layim_move"></span>    <a href="javascript:;" class="layim_face" target="_blank" ><img style="border: none;" src="" ></a>    <a href="javascript:;" class="layim_names" target="_blank" id="layim_title">    </a>    <span class="layim_rightbtn">        <i class="layer_setmin" onclick="$.ebTemp.event.close_chat_win()"></i>        <i class="layim_close" onclick="$(\'#layim_chatbox\').hide();$(\'#faces_div\').hide()"></i>    </span></h6><div class="layim_chatmore" id="layim_chatmore">    <ul class="layim_chatlist" id="layim_chatlist"></ul></div><div class="layim_groups" id="layim_groups"><ul class="layim_groupthis" id="layim_groupthis"></ul></div><div class="layim_chat">    <div class="layim_chatarea" id="layim_chatarea">    </div>    <div class="layim_tool">        <i class="layim_addface" title="发送表情" id="layim_addface"></i>        <a id="file_upload_btn" href="javascript:;"><i class="layim_addfile" title="上传文件"></i></a>    </div>    <textarea class="layim_write" id="layim_write" style="z-index: 999;"></textarea>    <div class="layim_send">        <div style="font-size: x-small;float: right;height: 40px;line-height: 45px;color:#77c08b;margin-right: 60px;">换行:ctrl+enter</div>        <div class="layim_sendbtn " id="layim_sendbtn">发送</div>    </div></div></div>',logon_win:'<div style="width: 300px;margin-left: 80px;"><table class="login-form"><tr><td><span>账号:</span></td><td><input id="accountInput" class="textInput" /></td></tr><tr><td><span>密码:</span></td><td><input id="passwordInput" class="textInput" type="password" /></td></tr><tr><td></td><td><div id="logonBtn">登录</div><div onclick="window.open(\'http://www.entboost.com/usercenter/register\');" id="regBtn">注册</div></td></tr></table></div>',logon_win_new:'<div class="eb-login" id="login_win"><div class="eb-logo"></div><div class="eb-input"><div><input type="text" id="accountInput" class="eb-form" placeholder="账号:"/></div><div><input type="password" id="passwordInput" class="eb-form" placeholder="密码:"/></div></div><div class="eb-button" id="logonBtn">登录</div><div class="down-button"><div id="regBtn" class="eb-button button-yellow" onclick="window.open(\'http://www.entboost.com/usercenter/register\');">IM注册</div><div class="eb-button button-blue" id="cus_btn">在线咨询</div></div></div>',main_win:'<div id="xximmm" class="xxim_main"><div class="xxim_top" id="xxim_top">  <div class="xxim_search"><img class="sbtn" src="./images/search.png" /><input placeholder="按回车搜索：用户、账号" id="xxim_searchkey" /><div id="searchuser_list" class="searchuser_list"></div><span id="xxim_closesearch">×</span></div>  <div class="xxim_tabs" id="xxim_tabs"><span class="xxim_tabgroup xxim_tabnow" title="群组"><img src="images/depart.png" alt=""/></span><span class="xxim_tabfriend" title="好友"><img src="images/user-white.png" alt=""/></span><span class="xxim_latechat"  title="组织架构"><img src="images/home-white.png" alt=""/></span></div>  <ul class="xxim_list" style="display: block;" id="group_list"></ul>  <ul class="xxim_list" style="display:none;" id="contact_list"><li style="display: none;" class="xxim_parentnode"><ul id="out_user" style="" class="xxim_chatlist"></ul></li></ul>  <ul class="xxim_list ztree " style="display: none;width: 100%;border: none;height: 320px;border: 0px;margin: 0px;" id="struct_list"></ul>  <ul class="xxim_list xxim_searchmain" id="xxim_searchmain"></ul></div><ul class="xxim_bottom" id="xxim_bottom"><li class="xxim_online" id="xxim_online"><i class="xxim_nowstate"></i><span id="xxim_onlinetex">在线</span><div class="xxim_setonline"><span><i></i>在线</span><span class="xxim_setoffline"><i></i>隐身</span></div></li><li class="xxim_mymsg" id="xxim_mymsg" title="最近会话"><img class="img_center" src="images/his.png" /></li><li class="xxim_seter" id="xxim_seter" title="设置" onclick="$.ebSetup.init();"><img class="img_center" src="images/setting.png" /><div class=""></div></li><li title="退出" class="xxim_hide" id="xxim_hide" onclick="$.ebTemp.event.exit();"><img class="img_center" src="images/exit.png" /></li><li id="xxim_on" class="xxim_icon xxim_on" onclick="$.ebTemp.event.expand();"></li><div state="not-active" class="layim_min" id="layim_min" style="display: none;" onclick="$.ebTemp.event.reopen_chat_win()">还原聊天窗口</div></ul></div>',chat_area:'<ul name="chat_area" class="layim_chatview layim_chatthis" ></ul>',card:$('<div  class="card"></div>'),recent_list:$('<div class="recent_list"></div>')};return obj}(),$.ebTemp.fun={min_chat_win_mes:function(){var state=$("#layim_min").attr("state");"active"==state&&($("#layim_min").html("<span  style='display: none;color: red;'>有新消息..............</span>"),$("#layim_min").find("span").show("slow"))},get_member_name:function(gid,uid){return $("#group_list li[gid='"+gid+"']").find("li[account='"+uid+"'] .xxim_onename").html()},remove_left_item:function(key){$("#layim_chatlist").children("li[account='"+key+"']").children("[name='close']").click()},recall:function(uid){$.ebCache.chat_win_cache[uid]=null,$("#layim_chatmore ul li[account='"+uid+"']").click()},show_chat_area:function(id){var chat_area=$.ebTemp.fun.check_chat_area(id);$("#layim_chatarea ul").hide(),chat_area.show()},check_chat_area:function(id){var chat_area=$("#layim_chatarea #"+id);if(chat_area.length<=0){var html=$.ebTemp.temps.chat_area;chat_area=$(html),chat_area.attr("id",id),chat_area.appendTo($("#layim_chatarea"))}return chat_area},push_info:function(id,content,callback){$.ebTemp.fun.min_chat_win_mes(),$.ebTemp.event.play_mes_ring();var chat_area=$.ebTemp.fun.check_chat_area(id),$content=$(content);$content.appendTo(chat_area),chat_area.scrollTop(chat_area[0].scrollHeight),$.ebTemp.event.count_msgs(id,"single"),callback&&callback($content)},push_msg:function(param,id){var template=function(param){return'<li class="'+("me"===param.type?"layim_chateme":"")+'"><div class="layim_chatuser">'+function(){return"me"===param.type?'<span class="layim_chattime">'+param.time.format("hh:mm:ss")+'</span><span class="layim_chatname">'+param.name+'</span><img src="'+param.face+'" >':'<img src="'+param.face+'" ><span class="layim_chatname">'+param.name+'</span><span class="layim_chattime">'+param.time.format("hh:mm:ss")+"</span>"}()+'</div><div class="layim_chatsay">'+param.content+'<em class="layim_zero"></em></div></li>'},chat_area=$.ebTemp.fun.check_chat_area(id);chat_area.append(template(param)),chat_area.scrollTop(chat_area[0].scrollHeight)}},$.ebTemp.event={screenshot_handler:function($this){$.layer({type:1,title:!1,fix:!1,offset:["50px",""],area:["auto","auto"],page:{html:"<div style='max-width: 800px;'><img style='max-width: 800px;' src='"+$this.attr("src")+" '/></div>"}})},get_user_info:function(uid){$.ebCache.handler_cart(uid,function(data){$.layer({type:1,area:["250px","400px"],border:[0],title:["用户信息","border:none; background:#61BA7A; color:#fff;"],bgcolor:"#eee",page:{html:'<div style="padding:10px;width: 250px;height: auto;"><div class="card_item"><span>姓名:</span>'+data.user_name+'</div><div class="card_item"><span>账号:</span>'+data.account+'</div><div class="card_item"><span>电话:</span>'+data.tel+'</div><div class="card_item"><span>手机:</span>'+data.phone+'</div><div class="card_item"><span>邮箱:</span>'+data.email+'</div><div class="card_item"><span>部门:</span>'+data.group_name+'</div><div class="card_item"><span>公司:</span>'+data.enterprise+'</div><div class="card_item"><span>地址:</span>'+data.address+"</div></div>"},shift:"none"})})},reopen_chat_win:function(){return $("#layim_min").is(":hidden")?void $("#layim_chatbox").show():($("#layim_chatbox").show(),$("#layim_min").hide(),$("#layim_min").attr("state","not-active"),void $("#layim_min").html("还原聊天窗口"))},close_chat_win:function(){$("#layim_chatbox").hide(),$("#faces_div").hide(),$("#layim_min").show(),$("#layim_min").attr("state","active")},play_mes_ring:function(){var enable=eb_client_config.mes_ring.open;if(enable){var borswer=window.navigator.userAgent.toLowerCase();if(borswer.indexOf("ie")>=0){var embed=document.mes_ring;embed&&embed.play&&embed.play()}else document.getElementById("mes_ring").play()}},exit:function(){layer.confirm("您确定退出吗?",function(){$.ebMsg.offline(function(){window.onbeforeunload=null,window.location.reload()},function(){window.onbeforeunload=null,window.location.reload()})})},expand:function(){var xxim={},node=xxim.node={tabs:$("#xxim_tabs>span"),list:$(".xxim_list"),online:$(".xxim_online"),setonline:$(".xxim_setonline"),onlinetex:$("#xxim_onlinetex"),xximon:$("#xxim_on"),layimFooter:$("#xxim_bottom"),xximHide:$("#xxim_hide"),xximSearch:$("#xxim_searchkey"),searchMian:$("#xxim_searchmain"),closeSearch:$("#xxim_closesearch"),layimMin:$("#layim_min")};"1"!==$("#xximmm").attr("state")?$("#xximmm").stop().animate({right:-232},200,function(){node.xximon.addClass("xxim_off");try{localStorage.layimState=1}catch(e){}$("#xximmm").attr({state:1}),node.layimFooter.addClass("xxim_expend").stop().animate({marginLeft:-232},100),node.xximHide.addClass("xxim_show")}):($("#xximmm").stop().animate({right:1},200,function(){node.xximon.removeClass("xxim_off");try{localStorage.layimState=2}catch(e){}$("#xximmm").removeAttr("state"),node.layimFooter.removeClass("xxim_expend"),node.xximHide.removeClass("xxim_show")}),node.layimFooter.stop().animate({marginLeft:0},200))},chatmore_add:function(account,name,type){$.ebTemp.cache.chat_win_index||$.ebTemp.temp_handler.show_chat_win({url:"javascript:;",face:eb_client_config.default_header,title:"加载中...",uid:"",account:"",call_id:""});var list=$("#layim_chatmore ul"),exist=!1;if(list.children("li").each(function(){var exist_account=$(this).attr("account");account==exist_account&&($(this).children("span").click(),$(this).addClass("layim_chatnow"),exist=!0)}),!exist){var temp=$('<li unread="0"  account="'+account+'" type="'+type+'"  class="layim_chatnow"><span onclick="$.ebTemp.event.call_click($(this).parent(),'+type+');">'+name+'</span><em style="display: none;" name="close">×</em><em style="color: red;display: none;" name="num"></em></li>');temp.appendTo(list),$("#layim_chatmore").show(),temp.mouseover(function(){$(this).children("[name='close']").show(),$(this).children("[name='num']").hide()}),temp.mouseout(function(){$(this).children("[name='close']").hide(),$(this).children("[name='num']").show()}),temp.children("em[name='close']").click(function(){$(this).parent().hasClass("layim_chatnow")?($(this).parent().remove(),$("#layim_chatmore ul li:last").children("span").click(),0==$("#layim_chatlist .layim_chatnow").length?$("#layim_chatmore ul li:last").children("span").click():$("#layim_chatlist").children(".layim_chatnow").click()):$(this).parent().remove();var account=$(this).parent().attr("account"),win_cache=$.ebCache.chat_win_cache[account];if(win_cache){var chat_id=win_cache.group_code||win_cache.callInfo.chat_id;$.ebCache.chat_win_cache[account]=null,$.ebTemp.cache.calling_cache[account]=null,$.jqEBMessenger.EBCM.ebwebcm_exit(chat_id)}0==$("#layim_chatlist li").length&&$("#layim_chatbox").hide()}),temp.children("span").click()}},click_contact:function($self){$.ebTemp.event.reopen_chat_win();var gid=$self.attr("gid"),account=$self.attr("account"),name=$self.attr("name");account?$.jqEBMessenger.clientInfo.my_uid!=account&&this.chatmore_add(account,name,$.jqEBMessenger.chat_type.single):gid&&this.chatmore_add(gid,name,$.jqEBMessenger.chat_type.group)},count_msgs:function(key,type){var list=$("#layim_chatlist").children("li[account='"+key+"']");0==list.length&&("group"==type?$("#group_list").children("li[gid='"+key+"']").find("[name='group_send_btn']").click():$(".xxim_list li[account='"+key+"']").click());var li=$("#layim_chatmore ul li[account='"+key+"']"),unread=parseInt(li.attr("unread"));unread+=1,li.attr("unread",""+unread),$("#layim_chatmore ul li").each(function(){var uns=$(this).attr("unread"),state=$(this).attr("class");"layim_chatnow"==state?($(this).find("[name='num']").html(""),$(this).attr("unread",0)):0>=uns?$(this).find("[name='num']").html(""):($(this).find("[name='num']").html(uns),uns>99&&$(this).find("[name='num']").html("99+"))})},fold:function($self){var ul=$self.parent();ul.attr("class").indexOf("xxim_liston")<0?(ul.addClass("xxim_liston"),ul.find(".xxim_chatlist").show()):(ul.removeClass("xxim_liston"),ul.find(".xxim_chatlist").hide())},_list_members:function(gid){if(!gid)return $("#layim_groups").hide(),void $("#layim_chatbox").removeClass("layim_add_width");$("#layim_groupthis").html("");$.ebCache.org_members[gid];$.ebCache.handler_members(gid,function(members){$.each(members,function(i,m){var head_file=m.head_file;0==$.trim(head_file).length&&(head_file=eb_client_config.default_header);var uid=m.member_uid,state_info=m.member_uid+"-"+m.line_state,temp=$('<li state_info="'+state_info+'"  onclick="$.ebTemp.event.click_contact($(this));" account="'+uid+'" name="'+m.user_name+'"><img src="'+head_file+'" class="xxim_oneface"><span class="xxim_onename">'+m.user_name+"</span></li>");$.im_state.set_state(temp,m.line_state),temp.appendTo($("#layim_groupthis")),temp.children("img").mouseover(function(){$.ebTemp.temp_init_handler._show_card(temp,1,temp.attr("account"),m)}),temp.children("img").mouseleave(function(){$.ebTemp.temps.card.remove()})}),$("#layim_chatbox").addClass("layim_add_width"),$("#layim_groups").show()})},_check_calling:function(account){var cache_time=$.ebTemp.cache.calling_cache[account];return!cache_time||(new Date).getTime()-parseInt(cache_time)>1e4?($.ebTemp.cache.calling_cache[account]=(new Date).getTime()+"",!0):!1},call_click:function($self,type){var account=$self.attr("account");if(account!=$.jqEBMessenger.clientInfo.my_uid){$("#layim_write").focus();var value=$.ebCache.wait_send_mes_map[account];if(value||(value=""),$("#layim_write").val(value),$self.find("[name='num']").html(""),$self.attr("unread","0"),type==$.jqEBMessenger.chat_type.single){$("#file_upload_btn").show(),this._list_members(!1);var info=$.ebCache.chat_win_cache[account];info?($.ebTemp.temp_handler.show_chat_win({url:"javascript:;",face:eb_client_config.default_header,title:info.accountInfo.fInfo.name.length>0?info.accountInfo.fInfo.name:info.accountInfo.from_account,uid:info.accountInfo.uid,account:info.accountInfo.uid,call_id:info.callInfo.chat_id}),$.ebTemp.fun.show_chat_area(info.accountInfo.uid)):this._check_calling(account)&&$.ebChat.call(account,$.jqEBMessenger.chat_type.single,null)}else if(type==$.jqEBMessenger.chat_type.group){$("#file_upload_btn").hide();var info=$.ebCache.chat_win_cache[account];if(info){var info=$.ebCache.get_group(account);$.ebTemp.temp_handler.show_chat_win({url:"javascript:;",face:eb_client_config.default_header,title:info.group_name,uid:info.group_code,account:info.group_code,call_id:info.group_code}),$.ebTemp.fun.show_chat_area(info.group_code)}else this._check_calling(account)&&$.ebChat.call(account,$.jqEBMessenger.chat_type.group,null);this._list_members(account)}}}},$.ebTemp.temp_init_handler={init_ring:function(){if(!$.ebTemp.cache.mes_ring_inited){var none_ie_temp=' <audio style="display: none;"  id="mes_ring" controls><source src="" /></audio>',ie_temp='<embed name="mes_ring" src="" autostart="true" hidden="true" loop="false"></embed>',borswer=window.navigator.userAgent.toLowerCase(),ring_obj=null;borswer.indexOf("ie")>=0?(ring_obj=$(ie_temp),ring_obj.attr("src",eb_client_config.mes_ring.sound_file)):(ring_obj=$(none_ie_temp),ring_obj.find("source").attr("src",eb_client_config.mes_ring.sound_file)),ring_obj.appendTo($("body")),$.ebTemp.cache.mes_ring_inited=!0}},init_chat_win:function(data){0==$(".xxim_list li[account='"+data.uid+"']").length&&"group"!=data.type&&$('<li style="display:none;" unread="0"  user_type="out_user" name="'+data.title+'"  account="'+data.uid+'" onclick="$.ebTemp.event.click_contact($(this));" ><img src="" class="xxim_oneface"><span class="xxim_onename"></span></li>').appendTo($("#out_user")),$(".layim_face").attr("href",data.url),$(".layim_face img").attr("src",data.face),$("#layim_title").html(data.title),$("#layim_title").attr("href",data.url),$("#layim_chatbox").attr("uid",data.uid),$("#layim_chatbox").attr("call_id",data.call_id),$("#xxim_top li[account='"+data.uid+"']").find("[name='unread']").text(""),$("#xxim_top li[account='"+data.uid+"']").attr("unread","0"),$("#xxim_top li[account='"+data.uid+"']").find("[name='unread']").hide();var uid=data.uid,list=$("#layim_chatmore ul");list.children("li").removeClass("layim_chatnow");var li=list.children("li[account='"+uid+"']");0==li.length?($("body [user_type='out_user'][account='"+uid+"']").click(),"group"==data.type?$("#group_list").children("li[gid='"+uid+"']").find("[name='group_send_btn']").click():$(".xxim_list li[account='"+uid+"']").click()):li.addClass("layim_chatnow"),"visitor"!=$.jqEBMessenger.clientInfo.user_type&&($("#layim_chatbox").find(".layim_face").removeAttr("target"),data.uid!=data.call_id?$("#layim_chatbox").find(".layim_face").attr("onclick","$.ebTemp.event.get_user_info("+data.uid+");"):$("#layim_chatbox").find(".layim_face").removeAttr("onclick"))},init_logon_win:function(logon_callback){$("#login_win").keydown(function(e){13==e.keyCode&&$("#logonBtn").click()}),$("#logonBtn").on("click",function(){var account=$.trim($("#accountInput").val()),password=$.trim($("#passwordInput").val());if(0===account.length)return void layer.alert("账号不能为空");if(0===password.length)return void layer.alert("密码不能为空");logon_callback(account,password),$("#passwordInput").val("")}),$("#reg_btn").click(function(){window.open("http://www.entboost.com/usercenter/register")}),$("#cus_btn").click(function(){window.open($.ebMsg.options.WEBIM_URL+"/client.html?to_account="+$.ebMsg.options.CUS_ACCOUNT)})},init_dom:function(){$.ebTemp.dom={send_btn:$("#layim_sendbtn"),face_btn:$("#layim_addface"),writer_area:$("#layim_write"),chat_area:$("#layim_area"),chat_box:$("#layim_chatbox"),upload_btn:$("#file_upload_btn")}},init_event:function(){var dom=$.ebTemp.dom;$("#layim_write").xheditor({tools:"Emot,Img",width:"100%",height:100,forcePtag:!0,layerShadow:0}),$("#xhe0_Tool").parent().hide(),$("#xhe0_iframearea").css("height","96px"),setInterval(function(){var value=$("#layim_write").val(),account=$("#layim_chatbox",parent.document).attr("uid");account&&parseInt(account)>0&&($.ebCache.wait_send_mes_map[account]=value)},500);var send_fun=function(){var msg=dom.writer_area.val();if(""===msg.replace(/\s/g,"")||0===$("<div>"+msg+"</div>").find("img").length&&0===$.trim($("<div>"+msg+"</div>").text()).length)layer.tips("说点啥呗！",dom.send_btn,2),dom.writer_area.val(""),dom.writer_area.focus();else{var uid=dom.chat_box.attr("uid"),call_id=dom.chat_box.attr("call_id");$.ebChat.send({uid:uid,call_id:call_id},msg)}};dom.send_btn.click(send_fun);var tframe=document.getElementById("xhe0_iframe").contentWindow||document.frames.xhe0_iframe[0],doc=tframe.document;$(doc.body).css("background-color","#EAFCFE"),$(doc.body).keydown(function(e){if(e.ctrlKey&&13==e.keyCode){var body=doc.getElementsByTagName("body")[0];body.innerHtml=body.innerText+"\r\n"}else 13==e.keyCode&&send_fun()}),$("#file_upload_btn").click(function(){var index=layer.prompt({title:"请选择要上传的文件",type:2},function(file){if(file){var file_input=document.getElementById("xubox_prompt"),agent=window.navigator.userAgent;if(-1!=agent.indexOf("MSIE"));else if(file_input.files[0].size>1048576)return void layer.alert("最多只支持大小为1M的文件");$("#xubox_prompt").attr("name","attachment_file");var chat_id=$("#layim_chatbox").attr("call_id"),errCodeMap=$.jqEBMessenger.errCodeMap;$.ebMsg.sendfile("xubox_prompt",chat_id,function(state,callId,fileName,mimeType,url){var callInfo=$.jqEBMessenger.chatMap.callInfoByChatId(callId),account=null;if(callInfo&&"0"!=callInfo.group_code)account=callInfo.group_code;else if(callInfo&&"0"==callInfo.group_code)for(var key in callInfo.accounts)if(key!=$.jqEBMessenger.clientInfo.my_uid){account=key;break}switch(state){case errCodeMap.SENDFILE_REQUEST_FAILURE:$.ebTemp.fun.push_info(account,"<div class='eb_info'>申请上传文件失败。</div>");break;case errCodeMap.UPLOAD_FILE_EMPTY:$.ebTemp.fun.push_info(account,"<div class='eb_info'>上传文件失败，请先选择一个文件后再点击传送。</div>");break;case errCodeMap.CONTENT_TOO_LONG:$.ebTemp.fun.push_info(account,"<div class='eb_info'>很抱歉！上传失败，文件超过最大限制(1MB-兆字节)。</div>");break;case errCodeMap.OK:var spls=fileName.split("\\"),showHtml=["<div class='eb_info'>","服务器已经成功保存离线文件：",spls[spls.length-1]];if($.jqEBMessenger.pictureMimeTypeMap[mimeType]){var image_url=['<img src="',url,'"'," onclick=\"window.open('",url,"')\"",' onload="adjustImgSize(this, 200,400);updateScroll();"',' style="cursor:pointer;margin-top:10px;max-width:200px;max-height:400px;"',"/>"].join("");showHtml.push("<br/>"),showHtml.push(image_url),text_area_log(image_url)}showHtml.push("</div>"),$.ebTemp.fun.push_info(account,showHtml.join(""))}},function(state,callId,fileName){var spls=fileName.split("\\");fileName=spls[spls.length-1];var errCodeMap=$.jqEBMessenger.errCodeMap,callInfo=$.jqEBMessenger.chatMap.callInfoByChatId(callId),account=null;if(callInfo&&"0"!=callInfo.group_code)account=callInfo.group_code;else if(callInfo&&"0"==callInfo.group_code)for(var key in callInfo.accounts)if(key!=$.jqEBMessenger.clientInfo.my_uid){account=key;break}switch(state){case errCodeMap.OK:var showHtml=["<div class='eb_info'>","对方已经成功接收到文件："+fileName,"</div>"];$.ebTemp.fun.push_info(account,showHtml.join(""));break;case errCodeMap.UPLOAD_FILE_REJECT:var showHtml=["<div class='eb_info'>","对方拒绝接收文件："+fileName,"</div>"];$.ebTemp.fun.push_info(account,showHtml.join(""))}}),layer.close(index)}},function(){});$(".xubox_setwin").hide()})},init_emos:function(emos){var top=$("#layim_addface").offset().top-230,left=$("#layim_addface").offset().left,temp='<div id="faces_div"  style="background:#fff;display:none;z-index:100000000;position: absolute;left:'+left+"px;top:"+top+'px;height: 200px;overflow: auto;width: 400px;padding:5px;border:1px solid #61BA7A;">';emos.sort(function(a,b){return parseInt(a.index)-parseInt(b.index)});for(var i=0;i<emos.length;i++){var emo=emos[i];if("6"==emo.res_type){var url=["http://",emo.server,"/servlet.ebwebcm.res?resid=",emo.resid].join(""),img='<img class="face" name="face" width="30px" height="30px" src="'+url+'"  resid="'+emo.resid+'" server="'+emo.server+'" cmserver="'+emo.server+'" desc="'+emo.desc+'" index="'+emo.index+'" type="'+emo.type+'" res_type="'+emo.res_type+'" />';temp+=img}}temp+="</div>",$("body").append(temp),$(".face").on("click",function(){var writeArea=$.ebTemp.dom.writer_area,html=writeArea.val()+'<img src="'+$(this).attr("src")+'"  resid='+$(this).attr("resid")+' desc="'+$(this).attr("desc")+'" cmserver="'+$(this).attr("cmserver")+'" />';writeArea.val(html),$("#faces_div").hide()}),$("#layim_addface").on("click",function(){var top=$("#layim_addface").offset().top-230,left=$("#layim_addface").offset().left;$("#faces_div").css("top",top+"px"),$("#faces_div").css("left",left+"px"),$("#faces_div").toggle(250)})},_init_contact:function(contacts){contacts||(contacts=[]),$.each(contacts,function(){});var contact_ul=$("#contact_list");if(!contacts||0==contacts.length){var html='<li data-id="1" class="xxim_parentnode"><h5><i></i><span class="xxim_parentname">默认分组</span><em class="xxim_nums">（0）</em></h5></li>';return void contact_ul.append(html)}var groups={},gname_array=[];$.each(contacts,function(i,m){var group_name=m.group;if(0===group_name.length&&(group_name="默认分组"),!groups[group_name]){var group=$('<li data-id="1" class="xxim_parentnode"><h5 onclick="$.ebTemp.event.fold($(this));"><i></i><span class="xxim_parentname">'+group_name+'</span><em class="xxim_nums">(0)</em></h5><ul style="display: none;" class="xxim_chatlist"></ul></li>');groups[group_name]=group,gname_array.push(group_name)}var state_info=m.con_uid+"-"+m.line_state,contact_title=m.name.length>0?m.name:m.contact,$li=$('<li state_info="'+state_info+'"  unread="0"  class="xxim_childnode" name="'+contact_title+'"  account="'+m.con_uid+'" onclick="$.ebTemp.event.click_contact($(this));" ><img src="'+$.eb_client_config.contact_img+'" class="xxim_oneface"><span class="xxim_onename">'+contact_title+"</span></li>");$.im_state.set_state($li,m.line_state),m.user_name=m.name,m.member_account=m.contact,$li.children("img").mouseover(function(){$.ebTemp.temp_init_handler._show_card($("#xxim_top"),1,$li.attr("account"),m)}),$li.children("img").mouseleave(function(){$.ebTemp.temps.card.remove()}),groups[group_name].find(".xxim_chatlist").append($li)});for(var j=0;j<gname_array.length;j++){var gname=gname_array[j];groups[gname].appendTo(contact_ul)}$("#contact_list .xxim_parentnode").each(function(){var size=$(this).find(".xxim_chatlist .xxim_childnode").length,online_size=$(this).find(".online").length;$(this).find("h5 .xxim_nums").html("["+online_size+"/"+size+"]")})},_show_card:function($dom,type,id,m){var $card=$.ebTemp.temps.card,top=$dom.offset().top,left=$dom.offset().left;if($card.removeClass("left"),$card.removeClass("top"),"layim_groupthis"==$dom.parent().attr("id")?$card.css("left",left+135):(top=$("#xxim_top").offset().top+200,$card.css("left",left-230-30)),$card.css("top",top),$card.html(""),1==type){var name=m.user_name.length>0?m.user_name:m.member_account;$('<div class="card_name">'+name+"("+id+")</div>").appendTo($card),$('<div class="card_des">'+m.description+"</div>").appendTo($card),$('<ul class="card_info"><li>电话：'+m.tel+" </li><li>手机："+m.phone+" </li><li>邮箱："+m.email+" </li><li>传真："+m.fax+" </li><li>地址："+m.address+" </li></ul>").appendTo($card);var group_info=$.ebCache.get_group(m.group_code);group_info&&$('<div class="card_from">'+group_info.group_name+"</div>").appendTo($card)}else if(2==type){var group_info=$.ebCache.get_group(id),name=group_info.group_name,fax=group_info.fax,addr=group_info.address,email=group_info.email,phone=group_info.phone,des=group_info.description,url=group_info.url,enterprise_code=group_info.enterprise_code,ent_name=$.ebCache.org.enterprise_info.enterprise_name,type="群组";enterprise_code&&parseInt(enterprise_code)>0&&(type="部门"),$('<div class="card_name">'+name+" - "+type+"："+id+"</div>").appendTo($card),$('<div class="card_des">'+des+"</div>").appendTo($card),$('<ul class="card_info"><li>电话：'+phone+" </li><li>网址："+url+" </li><li>邮箱："+email+" </li><li>传真："+fax+" </li><li>地址："+addr+" </li></ul>").appendTo($card),enterprise_code&&parseInt(enterprise_code)>0&&$('<div class="card_from">'+ent_name+"</div>").appendTo($card)}$card.appendTo($("body"))},_init_group:function(org){for(var groups=org.groups,my_groups=(org.members,[]),i=0;i<groups.length;i++){var group=groups[i],my_emp_id=parseInt(group.my_emp_id);if(0!=my_emp_id){my_groups.push(group);var group_obj=$('<li name="'+group.group_name+'" gid="'+group.group_code+'"  class="xxim_parentnode"><h5 ><i onclick="$.ebTemp.event.fold($(this).parent());"></i><span class="xxim_parentname" onclick="$.ebTemp.event.fold($(this).parent());">'+group.group_name+'</span><em class="xxim_nums"></em><span style="position: relative;left:10px;top:3px;display: none;" name="group_send_btn"  onclick="$.ebTemp.event.click_contact($(this).parent().parent());"><img  src="images/send.png" /></span></h5><ul style="display: none;" class="xxim_chatlist"></ul></li>'),h5=group_obj.children("h5");group_obj.appendTo($("#group_list")),h5.children(".xxim_parentname").mousemove(function(){$(this).parent().children("[name='group_send_btn']").show()}),h5.mouseleave(function(){$(this).children("[name='group_send_btn']").hide()}),h5.children("i").mousemove(function(){$.ebTemp.temp_init_handler._show_card($("#xxim_top"),2,$(this).parent().parent().attr("gid"))}),h5.children("i").mouseleave(function(){$.ebTemp.temps.card.remove()})}}for(var j=0;j<my_groups.length;j++){var group=my_groups[j],gid=group.group_code;$.ebCache.handler_members(gid,function(members){$.each(members,function(i,member){$.ebCache.my_group_members[member.member_uid]=member;var head_img=$.eb_client_config.contact_img;member.head_file.length>0&&(head_img=member.head_file);var contact_title=member.user_name.length>0?member.user_name:member.member_account,state_info=member.member_uid+"-"+member.line_state,$g_li=$('<li  state_info="'+state_info+'"  unread="0"  class="xxim_childnode" name="'+contact_title+'"  account="'+member.member_uid+'" onclick="$.ebTemp.event.click_contact($(this));" ><img  src="'+head_img+'" class="xxim_oneface"><span class="xxim_onename">'+contact_title+"</span></li>");$g_li.appendTo($("#group_list li[gid='"+member.group_code+"']").find(".xxim_chatlist")),$.im_state.set_state($g_li,member.line_state),$g_li.children("img").mouseover(function(){$.ebTemp.temp_init_handler._show_card($("#xxim_top"),1,$g_li.attr("account"),member)}),$g_li.children("img").mouseleave(function(){$.ebTemp.temps.card.remove()});var online_size=$("#group_list li[gid='"+member.group_code+"'] .online").length;$("#group_list li[gid='"+member.group_code+"']").find(".xxim_nums").html(" ["+online_size+"/"+members.length+"]")})})}},init_main_win:function(contacts,org){this._init_contact(contacts),this._init_group(org),$.eb_organize.init("struct_list"),$("#xxim_mymsg").click(function(){var recent_list=$.ebCache.recent_call_cache,$recent_list=$.ebTemp.temps.recent_list;$recent_list.html(""),$('<div style="line-height: 30px;font-size: 12px;padding-left: 5px;color:#b83b29;">最近会话<span class="recent_back" onclick="$.ebTemp.temps.recent_list.remove();"><<返回聊天</span></div>').appendTo($recent_list),$recent_list.css("top",$("#xxim_tabs").offset().top),$recent_list.css("left",$("#xxim_tabs").offset().left),$.each(recent_list,function(i,item){var type=item.type,id=item.id,time=Math.ceil(((new Date).getTime()-item.time)/1e3/60)+"分钟前",$temp=void 0;if("1"==type){var accountInfo=$.jqEBMessenger.accountInfoMap[id];if(accountInfo){var title=accountInfo.fInfo.name.length>0?accountInfo.fInfo.name:accountInfo.from_account,$user_lis=$(".xxim_childnode[account='"+id+"']"),state="offline";$user_lis.length>0&&$user_lis.hasClass("online")&&(state="online"),$temp=$('<div class="searchuser '+state+'" account="'+accountInfo.uid+'"><img src="images/logo2.gif" height="20px" width="20px"> '+title+'<span style="color:gray;"> - '+time+"</span></div>")}}else if("2"==type){var groupInfo=$.ebCache.get_group(id);groupInfo&&($temp=$('<div class="searchuser online" account="'+groupInfo.group_code+'"><img src="images/group.png" height="20px" width="20px"> '+groupInfo.group_name+'<span style="color:gray;"> - '+time+"</span></div>"))}$temp&&($temp.appendTo($recent_list),$temp.click(function(){var uid=$(this).attr("account");"1"==type?$(".xxim_childnode[account='"+uid+"']").length>0?$(".xxim_childnode[account='"+uid+"']").click():$.ebChat.call(uid,$.jqEBMessenger.chat_type.single,function(){},function(error){$.im_state.state_handler(error)}):"2"==type&&$("#group_list li[gid='"+uid+"'] [name='group_send_btn']").click()
}))}),$recent_list.appendTo($("body"))}),$("#xxim_tabs").children("span").click(function(){var type=$(this).attr("class");$("#xxim_tabs").children("span").removeClass("xxim_tabnow"),$("#xxim_tabs").children("span").each(function(){var imgSrc=$(this).find("img").attr("src");-1==imgSrc.indexOf("-white")&&(imgSrc=imgSrc.split(".")[0]+"-white.png",$(this).find("img").attr("src",imgSrc))}),$(this).addClass("xxim_tabnow");var imgName=$(this).find("img").attr("src");$(this).find("img").attr("src",imgName.replace(/-white/,"")),$("#contact_list,#group_list,#struct_list").hide(),type.indexOf("xxim_tabfriend")>-1?$("#contact_list").show():type.indexOf("xxim_tabgroup")>-1?$("#group_list").show():type.indexOf("xxim_latechat")>-1&&$("#struct_list").show()}),$("#xxim_searchkey").keyup(function(e){if(0==$.trim($(this).val()).length)return $("#searchuser_list").html(""),void $("#searchuser_list").hide();if("13"==e.keyCode){var search_list=$("#searchuser_list"),value=$.trim($(this).val());if(0==value.length)return void layer.alert("请输入关键字");search_list.html(""),$.ebCache.search_user(value,function(data){search_list.html("");var users=data.users;users.sort(function(a,b){return parseInt(b.line_state)-parseInt(a.line_state)}),users.length>0&&$("#searchuser_list").show();for(var i=0;i<users.length;i++){var user=users[i],name=user.user_name+" - "+user.member_account;user.user_name==user.member_account&&(name=user.user_name);var head_file=$.trim(user.head_file);head_file&&0!=head_file.length||(head_file=$.eb_client_config.contact_img);var $user=$('<div class="searchuser" account="'+user.member_uid+'"><img width="20px" height="20px"  src="'+head_file+'" /> '+name+"</div>");$.im_state.set_state($user,user.line_state),$user.click(function(){var uid=$(this).attr("account");return uid==$.jqEBMessenger.clientInfo.my_uid?void layer.alert("不能呼叫自己"):void($(".xxim_childnode[account='"+uid+"']").length>0?$(".xxim_childnode[account='"+uid+"']").click():$.ebChat.call(uid,$.jqEBMessenger.chat_type.single,function(){},function(error){$.im_state.state_handler(error)}))}),$user.appendTo(search_list)}},function(state){$.im_state.state_handler(state)})}})}},$.ebTemp.cache={chat_win_index:null,chat_win_map:{},mes_ring_inited:!1,calling_cache:{}},$.ebTemp.temp_handler={show_main_win:function(contacts,org){$("body").append($.ebTemp.temps.main_win),$.ebTemp.temp_init_handler.init_main_win(contacts,org),$.ebTemp.temp_init_handler.init_ring()},show_chat_win:function(data){if($.ebTemp.cache.chat_win_index)$.ebTemp.temp_init_handler.init_chat_win(data),$("#layim_chatbox").show();else{var win_index=$.layer({type:1,border:[0],title:!1,shade:[0],area:["620px","493px"],move:".layim_chatbox .layim_move",moveType:1,closeBtn:!1,offset:[($(window).height()-493)/2+"px",""],page:{html:$.ebTemp.temps.chat_win}});$.ebTemp.cache.chat_win_index=win_index,$.ebTemp.temp_init_handler.init_dom(),$.ebTemp.temp_init_handler.init_event(),$.ebTemp.temp_init_handler.init_chat_win(data),$.ebTemp.temp_init_handler.init_ring(),$.ebTemp.temp_init_handler.init_emos($.ebCache.org.emotions),$.im_state.init()}},show_logon_win:function(logon_callback){var html=$.ebTemp.temps.logon_win_new;$(html).appendTo($("body")),$.ebTemp.temp_init_handler.init_logon_win(logon_callback),$("#accountInput").focus(),$.ebCache.logon_win_index="login_win"},close_logon_win:function(){$("#"+$.ebCache.logon_win_index).hide(),$.ebCache.logon_win_index=null,$("body").css("background","#fff"),$(".eb_error_tag").hide()}}}(window,jQuery),function(window,$){var $_GET=function(){var url=window.document.location.href.toString(),u=url.split("?");if("string"==typeof u[1]){u=u[1].split("&");var get={};for(var i in u){var j=u[i].split("=");get[j[0]]=j[1]}return get}return{}}(),CallAndAccountInfo=function(callInfo,accountInfo){this.callInfo=callInfo,this.accountInfo=accountInfo};$.extend({ebCache:{recent_call_cache:[],search_user:{},recall_cache:{},card_cache:{},wait_send_mes_map:{},cur_contact_id:null,org:{},org_members:{},org_member:{},my_group_members:{},org_loaded:!1,$_GET:$_GET,user_type:"1",chat_win_cache:{},call_time:{},logon_win_index:null,ack_file:function(call_id,msg_id,url){$.ebMsg.fileack(call_id,msg_id,0,function(){window.open(url)},function(state){im_state.state_handler(state)})},handler_cart:function(uid,callback){var card=$.ebCache.card_cache[uid];card?callback(card):$.ebMsg.userQuery(uid,function(data){callback(data),$.ebCache.card_cache[uid]=data},function(state){$.im_state.state_handler(state)})},add_recent_call:function(type,id){for(var cache=$.ebCache.recent_call_cache,n=0,i=0;i<cache.length;i++){var item=cache[i];if(item.type==type&&item.id==id){n++;break}}0==n&&cache.push({type:type,id:id,time:(new Date).getTime()})},handler_member:function(type,uid,callback){var member=$.ebCache.org_member[uid];member?callback(member):$.ebMsg.queryUser(type,uid,function(member){member&&callback(member)},function(){})},search_user:function(key,callback){var search_cache=$.ebCache.search_user[key];search_cache?callback(search_cache):$.ebMsg.searchuser(key,function(data){$.ebCache.search_user[key]=data,callback(data)},function(state){$.im_state.state_handler(state)})},handler_members:function(gid,callback){var sort_members=function(membs){membs.sort(function(a,b){if(a.line_state!=b.line_state)return b.line_state-a.line_state;var str1=$URL.toGBKInt(a.user_name),str2=$URL.toGBKInt(b.user_name);return str1>str2?1:-1})},update_ols=function(group_id,members,call){$.ebMsg.loadols(group_id,function(params){for(var ols=params.user_ols,i=0;i<members.length;i++){var m=members[i];m.line_state="2";for(var j=0;j<ols.length;j++){var ol=ols[j];ol.user_id==m.member_uid&&(m.line_state=ol.line_state)}}sort_members(members),call(members),$.ebCache.org_members[group_id]=members},function(){layer.alert(error.msg)})},members=$.ebCache.org_members[gid];if(members)update_ols(gid,members,callback);else{var storage=window.localStorage,group=$.ebCache.get_group(gid),store_ver=storage.getItem("version:"+gid);if(storage&&store_ver==group.group_ver&&storage.getItem("members:"+gid)){var store_members=JSON.parse(storage.getItem("members:"+gid));update_ols(gid,store_members,callback)}else $.ebMsg.loadorg({group_code:gid,load_my_group:"0",load_ent_dep:"0",load_image:"0"},function(org){org&&org.members&&(sort_members(org.members),callback(org.members),$.ebCache.org_members[gid]=org.members,window.localStorage&&(storage=window.localStorage,storage.setItem("members:"+gid,JSON.stringify(org.members)),storage.setItem("version:"+gid,group.group_ver)))},function(error){layer.alert(error.msg)})}},get_group:function(gid){for(var groups=this.org.groups,result=null,i=0;i<groups.length;i++){var group=groups[i];if(group.group_code==gid){result=group;break}}return result},get_chats:function(uid){var chat_list=this.chat_cache[uid];return chat_list||(this.chat_cache[uid]=[]),this.chat_cache[uid]},add_call_account_cache:function(callInfo,accountInfo){var call_account_info=new CallAndAccountInfo(callInfo,accountInfo);this.call_account_cache[accountInfo.uid]=call_account_info,this.call_account_cache[accountInfo.from_account]=call_account_info},get_call_account_cache:function(uid){var cache=this.call_account_cache[uid];return cache},add_logon_user:function(logonUser){this.logon_user_cache=logonUser},get_logon_user:function(){return this.logon_user_cache},remove_logon_user:function(){this.logon_user_cache=null}}})}(window,jQuery),function(window,$){var eb_client_config=$.eb_client_config,cache=($.ebTemp.temps,$.ebCache),treeId=null;$.extend({eb_organize:{reList:function(data){var uid=(data.group_id,data.from_uid),state=(data.from_account,data.line_state),treeObj=$.fn.zTree.getZTreeObj(treeId),nodes=treeObj.getNodesByFilter(function(node){return node.id==uid});$.each(nodes,function(index,node){node.line_state=state;var parentNode=node.getParentNode(),nodeList=parentNode.children;nodeList.sort(function(a,b){if(a.line_state!=b.line_state)return b.line_state-a.line_state;var str1=$URL.toGBKInt(a.name),str2=$URL.toGBKInt(b.name);return str1>str2?1:-1}),treeObj.removeChildNodes(parentNode),treeObj.addNodes(parentNode,nodeList),nodeList=parentNode.children,$.each(nodeList,function(index,node){$.eb_organize._set_iconcss(node)})})},_init_data:function(){var org=cache.org,depart_info=org.enterprise_info,groups=org.groups,data=(org.members,[]);data.push({isRoot:!0,id:"0",name:depart_info.enterprise_name+" ["+$.eb_organize._count_members()+"]",open:!0});for(var i=0;i<groups.length;i++){var g=groups[i];"0"!=g.enterprise_code&&(g.pId=g.parent_code,g.name=g.group_name+" ["+g.emp_count+"]",g.id=g.group_code,g.isParent=!0,data.push(g))}return data.sort(function(a,b){return a.display_index-b.display_index}),data},_node_click:function(event,treeId,treeNode){var eb_tree=$.fn.zTree.getZTreeObj(treeId);treeNode.isParent&&(treeNode.open?eb_tree.expandNode(treeNode,!1,!1,!0,!0):eb_tree.expandNode(treeNode,!0,!1,!0,!0));var member_uid=treeNode.member_uid,name=treeNode.name;if(member_uid){var $obj=$('<div account="'+member_uid+'" name="'+name+'"></div>');$.ebTemp.event.click_contact($obj)}},_node_expanded:{},vvv:"123",_set_iconcss:function(node){var icon=node.icon,$img=$("<img />");$img.attr("src",icon),$img.css("width","17px"),$img.css("height","17px"),$img.css("position","relative"),$img.css("top","14px");var $imgSpan=$("#"+node.tId).find(".ico_docu");$img.appendTo($imgSpan),$imgSpan.removeAttr("style"),$.im_state.set_state($imgSpan,node.line_state)},_count_members:function(){var org=$.ebCache.org,groups=org.groups,allMembers=0;return $.each(groups,function(index,group){allMembers+=parseInt(group.emp_count)}),allMembers},_node_expand:function(event,treeId,treeNode){var expands=$.eb_organize._node_expanded,eb_tree=$.fn.zTree.getZTreeObj(treeId);expands[treeNode.id]||"0"!=treeNode.id&&cache.handler_members(treeNode.id,function(members){for(var newNodes=[],i=0;i<members.length;i++){var m=members[i];if("0"!=cache.get_group(m.group_code).enterprise_code){m.id=m.member_uid,m.pId=m.group_code,m.isParent=!1;var headFile=eb_client_config.organize.member_icon;m.head_file&&m.head_file.length>0&&(headFile=m.head_file),m.icon=headFile,m.name=m.user_name.length>0?m.user_name:m.member_account,newNodes.push(m)}}eb_tree.addNodes(treeNode,newNodes,!0),treeNode.expanded=!0,expands[treeNode.id]=!0;var nodeList=treeNode.children;$.each(nodeList,function(index,node){$.eb_organize._set_iconcss(node)})})},init:function(id){function addDiyDom(treeId,treeNode){var spaceWidth=5,switchObj=$("#"+treeNode.tId+"_switch"),icoObj=$("#"+treeNode.tId+"_ico");if(switchObj.remove(),icoObj.before(switchObj),treeNode.level>1){var spaceStr="<span style='display: inline-block;width:"+spaceWidth*treeNode.level+"px'></span>";switchObj.before(spaceStr)}}if(treeId=id,!cache.org.enterprise_info)return void $(".xxim_latechat").hide();var click_event=this._node_click,expand_event=this._node_expand,setting={data:{simpleData:{enable:!0}},callback:{onClick:click_event,onExpand:expand_event},view:{showLine:!1,showIcon:!1,selectedMulti:!1,dblClickExpand:!1,addDiyDom:addDiyDom}},init_data=this._init_data();$.fn.zTree.init($("#"+id),setting,init_data);var treeObj=$("#"+id);treeObj.addClass("showIcon");var eb_tree=$.fn.zTree.getZTreeObj(treeId),root=eb_tree.getNodesByFilter(function(node){return"0"==node.id},!0),$button=$("#"+root.tId).find(".switch:first"),$comImage=$("<img src='"+eb_client_config.organize.ent_icon+"' />");$comImage.css("width","20px;"),$comImage.css("height","20px"),$comImage.appendTo($button)}}})}(window,jQuery),function(window,$){{var jqEBM=$.jqEBMessenger;$.ebChat}$.extend({im_state:{_cmhb_error:function(){var times=jqEBM.cmhbAuthErrorTimes;times>=5&&(window.onbeforeunload=null,setTimeout("location.replace(location.href)",5e3),$.layer({shade:[.5,"#000"],area:["auto","auto"],closeBtn:!1,dialog:{msg:"登录状态已经失效!",btns:1,type:8,btn:["重新登录"],yes:function(){location.replace(location.href)}}}))},_tick_off:function(){jqEBM.clientInfo.tickoff&&(window.onbeforeunload=null,setTimeout("location.replace(location.href)",1e4),$.layer({shade:[.5,"#000"],area:["auto","auto"],closeBtn:!1,dialog:{msg:"您的账号在别处登录了！",btns:1,type:8,btn:["重新登录"],yes:function(){location.replace(location.href)}}}))},state_handler:function(state,index){index&&layer.close(index),$(".eb_error_tag").show();var text="未知错误";state.msg&&(text=state.msg),$("#error_span").html(state.msg),setTimeout(function(){$(".eb_error_tag").hide()},3e3)},kick_off_listerner:function(){setInterval($.im_state._tick_off,2e3)},check_leave:function(){window.onbeforeunload=function(){return"该操作将放弃保存当前的消息内容"},window.onunload=function(){$.ebMsg.offline(function(){},function(){})}},cmhb_error_listerner:function(){setInterval($.im_state._cmhb_error,2e3)},set_state:function($element,state){"5"==state?($element.removeClass("busy"),$element.removeClass("leave"),$element.removeClass("offline"),$element.addClass("online")):"2"==state||"0"==state?($element.removeClass("busy"),$element.removeClass("leave"),$element.removeClass("online"),$element.addClass("offline")):"3"==state?($element.removeClass("leave"),$element.removeClass("online"),$element.removeClass("offline"),$element.addClass("busy")):"4"==state&&($element.removeClass("busy"),$element.removeClass("online"),$element.removeClass("offline"),$element.addClass("leave"))},init:function(){var im_state=$.im_state;im_state.kick_off_listerner();var agent=window.navigator.userAgent;-1==agent.indexOf("MSIE")&&im_state.check_leave()}}})}(window,jQuery),function(window,$){var eb_client_config=$.eb_client_config,im_state=$.im_state;$.extend({ebChat:{send:function(chatParam,chat){var uid=chatParam.uid,call_id=chatParam.call_id,root_chat=chat;chat=chat.replace(/<br \/>/gi,"\n"),chat=chat.replace(/<\/p>/g,"\n"),chat=chat.replace(/<p>/g,""),chat=$.trim(chat),$.ebMsg.sendMessage(call_id,chat,function(){"visitor"==$.jqEBMessenger.clientInfo.user_type&&($.jqEBMessenger.clientInfo.username="游客"),$.ebTemp.fun.push_msg({content:root_chat,name:$.jqEBMessenger.clientInfo.username.length>0?$.jqEBMessenger.clientInfo.username:$.jqEBMessenger.clientInfo.my_account,face:eb_client_config.my_head_img,time:new Date,type:"me"},uid),$.ebTemp.dom.writer_area.val(""),$.ebTemp.dom.writer_area.focus(),$.ebCache.wait_send_mes_map[uid]=""},function(){var recall_info=$.ebCache.recall_cache[uid],type=$.jqEBMessenger.chat_type.single;recall_info&&("0"!=recall_info.group_code&&(type=$.jqEBMessenger.chat_type.group),$.ebChat.call(uid,type,recall_info.chat_id))})},call:function(target,type,chat_id){target=$.trim(target),type==$.jqEBMessenger.chat_type.single?$.ebMsg.callAccount(target,chat_id,null,function(){},function(error){im_state.state_handler(error),$.ebTemp.fun.remove_left_item(target)}):type==$.jqEBMessenger.chat_type.group&&$.ebMsg.callGroup(target,chat_id,function(){},function(error){im_state.state_handler(error),$.ebTemp.fun.remove_left_item(target)})},logonVistor:function(call_num){$("body").css("background","#fff"),$.eb_client_config.cs.init();var load_index=layer.load();$.ebCache.user_type="2",$.ebMsg.logonVisitor(function(){$.ebMsg.online(function(){$.ebMsg.loadorg({load_ent_dep:0,load_my_group:0,load_emp:0},function(org){org&&org.emotions&&($.ebCache.org=org,$.ebMsg.callAccount(call_num,null,null,function(){layer.close(load_index),$(".layim_rightbtn").hide()},function(error){im_state.state_handler(error,load_index)}))},function(state){im_state(state,load_index)})},function(state){im_state(state,load_index)})},function(state){im_state.state_handler(state,load_index)})},logon:function(){var logon_user=$.jqEBMessenger.clientInfo;return logon_user&&"0"==logon_user.line_state?void $.ebTemp.temp_handler.show_logon_win(function(account,password){$.ebMsg.queryUser(2,account,function(user){var md5_password=$.md5(user.uid+""+password).toLowerCase(),load_index=layer.load("登录中...",60);$.ebMsg.logonAccount(user.uid,md5_password,4096,function(){$.ebMsg.online(function(){$.ebMsg.loadcontact(function(contactList){$.ebMsg.loadorg({load_emp:"0"},function(org){if(!$.ebCache.org_loaded){$.ebCache.org_loaded=!0,$.ebCache.org=org;var groups=org.groups;groups.sort(function(a,b){return a.enterprise_code==b.enterprise_code?a.group_name>b.group_name?1:-1:a.enterprise_code-b.enterprise_code}),$.ebTemp.temp_handler.show_main_win(contactList,org),$.im_state.init(),layer.close(load_index),$.ebTemp.temp_handler.close_logon_win()}},function(state){im_state.state_handler(state,load_index)})},function(state){im_state.state_handler(state,load_index)})})},function(state){im_state.state_handler(state,load_index)})},function(state){im_state.state_handler(state)})}):void 0}}}),$.ebMsg.eventHandle.onReceiveMessage=function(callInfo,accountInfo,richInfo){$.ebTemp.fun.min_chat_win_mes(),$.ebTemp.event.play_mes_ring();for(var content="",i=0;i<richInfo.length;i++){var mes=richInfo[i];"text"==mes.type?content+=$.ebfn.htmlEncode(mes.content):(mes.type="screenshot")?content+="<img type='screenshot' onclick='$.ebTemp.event.screenshot_handler($(this));' style='max-width:250px;cursor:pointer;' src='"+mes.content+"'/>":(mes.type="emotion")&&(content+="<img src='"+mes.content+"'    />")}if("0"!=callInfo.group_code){type="he";var face=eb_client_config.opposite_head_img,name=$.ebTemp.fun.get_member_name(callInfo.group_code,accountInfo);accountInfo==$.jqEBMessenger.clientInfo.my_uid&&(type="me",face=eb_client_config.my_head_img),$.ebTemp.event.count_msgs(callInfo.group_code,"group"),$.ebTemp.fun.push_msg({content:content,name:name,face:face,time:new Date,type:type},callInfo.group_code)}else{accountInfo||"0"==callInfo.group_code&&(accountInfo={},accountInfo.uid=$.jqEBMessenger.clientInfo.my_uid);var uid=accountInfo.uid;$.ebTemp.event.count_msgs(uid,"single");var type="he",name="",face=eb_client_config.opposite_head_img;if($.jqEBMessenger.clientInfo.my_uid==uid){for(var key in callInfo.accounts)if(key!=uid){uid=key,type="me",name=$.jqEBMessenger.clientInfo.username,face=eb_client_config.my_head_img;break}}else name=accountInfo.fInfo.name.length>0?accountInfo.fInfo.name:accountInfo.from_account,0==name.length&&(name=accountInfo.uid);$.ebTemp.fun.push_msg({content:content,name:name,face:face,time:new Date,type:type},uid)}$.ebTemp.event.reopen_chat_win()},$.ebMsg.eventHandle.onReceiveFile=function(callInfo,from_uid,file_info){$.ebTemp.fun.push_info(from_uid,"<div class='eb_info'>收到文件："+file_info.file+"（"+file_info.size+"字节） <a name='ack_file"+file_info.msg_id+"'  href='javascript:;'>下载</a><a target='_blank' name='common_link' style='display: none;' href='"+file_info.url+"'>下载</a></div>"),$("[name='ack_file"+file_info.msg_id+"']").mouseover(function(){$.ebMsg.fileack(callInfo.chat_id,file_info.msg_id,0,function(){$("[name='ack_file"+file_info.msg_id+"']").next().show(),$("[name='ack_file"+file_info.msg_id+"']").hide()},function(state){im_state.state_handler(state)})}),$.ebTemp.event.reopen_chat_win()},$.ebMsg.eventHandle.onReceivingFile=function(callInfo,from_uid,file_info){$.ebTemp.fun.push_info(from_uid,"<div class='eb_info' name='file_reving"+file_info.msg_id+"'>对方发送文件："+file_info.file+"<span><a href='javascript:;' style='color: #0075BF;'>&nbsp;接收</a> <a style='color: red;'  href='javascript:;'>&nbsp;拒绝</a></span></div>"),$("[name='file_reving"+file_info.msg_id+"'] a:eq(0)").click(function(){$.ebMsg.fileack(callInfo.chat_id,file_info.msg_id,3,function(){$("[name='file_reving"+file_info.msg_id+"'] span").html("<span style='color:#b84d20;'>&nbsp;正在接收</span>")},function(state){im_state.state_handler(state)})}),$("[name='file_reving"+file_info.msg_id+"'] a:eq(1)").click(function(){$.ebMsg.fileack(callInfo.chat_id,file_info.msg_id,2,function(){$("[name='file_reving"+file_info.msg_id+"'] span").html("<span style='color:red;'>&nbsp;已经拒绝</span>")},function(state){im_state.state_handler(state)})}),$.ebTemp.event.reopen_chat_win()},$.ebMsg.eventHandle.onLineStateChange=function(data){$.eb_organize.reList(data);var uid=(data.group_id,data.from_uid),account=data.from_account,state=data.line_state,accounts=$("li[state_info][account='"+uid+"'],li[state_info][account='"+account+"']"),ul_list=[];accounts.each(function(){$.im_state.set_state($(this),state);var state_info=$(this).attr("account")+"-"+state;$(this).attr("state_info",state_info),ul_list.push($(this).parent())});for(var i=0;i<ul_list.length;i++){var ul=ul_list[i],lis=ul.find("li[account]"),new_lis=lis.toArray().sort(function(a,b){if(a.getAttribute("state_info")&&b.getAttribute("state_info")){var state_a=parseInt(a.getAttribute("state_info").split("-")[1]),state_b=parseInt(b.getAttribute("state_info").split("-")[1]);if(state_a!=state_b)return state_b-state_a;var name_a=$URL.toGBKInt(a.getAttribute("name")),name_b=$URL.toGBKInt(b.getAttribute("name"));return name_a>name_b?1:-1}return-1});ul.html(""),$(new_lis).appendTo(ul),ul.children("li").each(function(){var uid=$(this).attr("account"),member=$.ebCache.my_group_members[uid];$.ebCache.handler_member();var $g_li=$(this);$g_li.children("img").mouseover(function(){$.ebTemp.temp_init_handler._show_card($g_li,1,$g_li.attr("account"),member)}),$g_li.children("img").mouseleave(function(){$.ebTemp.temps.card.remove()})});for(var user_count=$(new_lis).length,online_count=0,p=0;p<new_lis.length;p++){var li=new_lis[p];$(li).hasClass("online")&&online_count++}ul.parent().find("h5 .xxim_nums").html("["+online_count+"/"+user_count+"]")}},$.ebMsg.eventHandle.onLoadEmotions=function(emotions){$.ebCache.emos=emotions},$.ebMsg.eventHandle.onChatInvalid=function(callInfo){var account,type=$.jqEBMessenger.chat_type.single;if("0"==callInfo.group_code){var accounts=callInfo.accounts;for(var key in accounts)key!=$.jqEBMessenger.clientInfo.my_uid&&(account=key)}else{var type=$.jqEBMessenger.chat_type.group;account=callInfo.group_code}var chat_id=callInfo.chat_id;$.ebTemp.fun.push_info(account,"<div class='eb_info' recall_account='"+account+"'>当前会话已经失效。<button style='color:red;' onclick='$.ebChat.call("+account+","+type+","+chat_id+");'>重新进入</button></div>"),$.ebCache.recall_cache[account]=callInfo,$.ebTemp.event.reopen_chat_win()},$.ebMsg.eventHandle.onEnterCall=function(callInfo){var accounts=callInfo.accounts,group_code=callInfo.group_code;if("0"==group_code){var uid;for(var key in accounts)key!=$.jqEBMessenger.clientInfo.my_uid&&(uid=key);var recall_info=$.ebCache.recall_cache[uid];recall_info&&($.ebTemp.fun.push_info(uid,"<div class='eb_info'>重新进入会话成功。</div>",function($content){setTimeout(function(){$content.fadeOut()},2e3)}),$("[recall_account='"+uid+"']").remove(),$.ebCache.recall_cache[uid]=null);var accountInfo=$.jqEBMessenger.accountInfoMap[uid];$.ebCache.chat_win_cache[uid]={callInfo:callInfo,accountInfo:accountInfo},$.ebCache.chat_win_cache[accountInfo.from_account]={callInfo:callInfo,accountInfo:accountInfo,uid:uid};var title=accountInfo.fInfo.name.length>0?accountInfo.fInfo.name:accountInfo.from_account;0==title.length&&(title=accountInfo.uid),"2"==$.ebCache.user_type?$.ebTemp.temp_handler.show_chat_win({url:eb_client_config.url,face:eb_client_config.default_header,title:eb_client_config.title,uid:accountInfo.uid,account:accountInfo.from_account,call_id:callInfo.chat_id}):($.ebTemp.temp_handler.show_chat_win({url:"javascript:;",face:eb_client_config.default_header,title:title,uid:uid,account:accountInfo.from_account,call_id:callInfo.chat_id}),$.ebCache.add_recent_call("1",uid)),$.ebTemp.fun.show_chat_area(uid)}else{var group_code=callInfo.group_code,recall_info=$.ebCache.recall_cache[group_code];recall_info&&($.ebTemp.fun.push_info(group_code,"<div class='eb_info'>重新进入会话成功。</div>",function($content){setTimeout(function(){$content.fadeOut()},2e3)}),$("[recall_account='"+group_code+"']").remove(),$.ebCache.recall_cache[group_code]=null);var group_info=$.ebCache.get_group(group_code);$.ebCache.chat_win_cache[group_code]=group_info,$.ebTemp.temp_handler.show_chat_win({url:"javascript:;",face:eb_client_config.default_header,title:group_info.group_name,uid:group_code,account:group_code,call_id:group_code,type:"group"}),$.ebCache.add_recent_call("2",group_code),$.ebTemp.fun.show_chat_area(group_code)}$.ebTemp.event.reopen_chat_win()},$.ebMsg.eventHandle.onDisconnect=function(){window.onbeforeunload=void 0;var exit_url=$.ebMsg.options.WEBIM_URL+"/client.html";setTimeout(function(){window.location.href=exit_url},1e4),layer.alert("登陆状态已失效，请重新登陆!",function(){window.location.href=exit_url})}}(window,jQuery),function(window,$){$.extend({ebSetup:{init:function(){var accountTmp=['<table id="account_table"  style="font-size: 12px;width: 80%;margin-left: 10%;margin-top: 20px;" cellspacing="10px;">',"<tr>","<td>账号</td>",'<td><input name="account" readonly="readonly" /></td>',"<td>名称</td>",'<td><input name="username" /></td>',"</tr>","<tr>","<td>性别</td>",'<td><select name="gender" ><option value="0"></option><option value="2">男</option><option value="3">女</option></select></td>',"<td>生日</td>",'<td><input name="birthday" placeholder="格式:19870213" /></td>',"</tr>","<tr>","<td>手机</td>",'<td><input name="mobile" /></td>',"<td>电话</td>",'<td><input name="tel" /></td>',"</tr>","<tr>","<td>邮箱</td>",'<td><input name="email"  /></td>',"<td>主页</td>",'<td><input name="url" /></td>',"</tr>","<tr>","<td>地址</td>",'<td><input name="add" /></td>',"<td>邮编</td>",'<td><input name="zipcode" /></td>',"</tr>","<tr>","<td>备注</td>",'<td colspan="3"><textarea name="desc" style="resize: none;"  cols="30" rows="5"></textarea></td>',"</tr>","<tr>","<td> </td>","<td></td>","<td></td>",'<td><input   type="button" value="保存" /> </td>',"</tr>","</table>"].join(""),resetpwdTmp=['<table id="resetpwd_table" style="font-size: 12px;width: 80%;margin-left: 10%;margin-top: 30px;" cellspacing="30px;">',"<tr>","<td>当前密码</td>",'<td><input name="currentPwd"  type="password"/></td>',"</tr>","<tr>","<td>新密码</td>",'<td><input name="newPass" type="password"/></td>',"</tr>","<tr>","<td>确认密码</td>",'<td><input name="repeatPass" type="password" /></td>',"</tr>","<tr>","<td></td>",'<td><input type="button" value="保存"   /></td>',"</tr>","</table>"].join("");layer.tab({area:["600px","400px"],data:[{title:"账号信息",content:accountTmp},{title:"修改密码",content:resetpwdTmp}]});var myInfo=$.jqEBMessenger.clientInfo;$("#account_table [name='account']").val(myInfo.my_account),$("#account_table [name='username']").val(myInfo.username),$("#account_table [name='gender']").val(myInfo.gender),$("#account_table [name='birthday']").val(myInfo.birthday),$("#account_table [name='mobile']").val(myInfo.mobile),$("#account_table [name='tel']").val(myInfo.tel),$("#account_table [name='email']").val(myInfo.email),$("#account_table [name='url']").val(myInfo.user_url),$("#account_table [name='add']").val(myInfo.add),$("#account_table [name='zipcode']").val(myInfo.zipcode),$("#account_table [name='desc']").val(myInfo.description),$("#account_table :input").css("width","95%"),$("#account_table :input").css("height","30px"),$("#account_table textarea").css("width","99%"),$("#account_table textarea").css("height","40px"),$("#account_table :button").css("width","50%"),$("#account_table :button").css("float","right"),$("#account_table :button").click(function(){var params={user_name:$("#account_table [name='username']").val(),desc:$("#account_table [name='desc']").val(),add:$("#account_table [name='add']").val(),url:$("#account_table [name='url']").val(),gender:$("#account_table [name='gender']").val(),tel:$("#account_table [name='tel']").val(),mobile:$("#account_table [name='mobile']").val(),email:$("#account_table [name='email']").val(),birthday:$("#account_table [name='birthday']").val(),zipcode:$("#account_table [name='zipcode']").val()};$.ebMsg.sinfo(params,function(data){var code=data.code;"0"==code?(alert("个人资料修改成功!"),myInfo.username=params.user_name,myInfo.description=params.desc,myInfo.add=params.add,myInfo.user_url=params.url,myInfo.gender=params.gender,myInfo.tel=params.tel,myInfo.mobile=params.mobile,myInfo.email=params.email,myInfo.birthday=params.birthday,myInfo.zipcode=params.zipcode):alert("个人资料修改失败: "+data.error)},function(error){$.im_state.state_handler(error)})}),$("#resetpwd_table :password").css("width","98%"),$("#resetpwd_table :password").css("height","30px"),$("#resetpwd_table :button").css("width","30%"),$("#resetpwd_table :button").css("float","right"),$("#resetpwd_table :button").css("height","30px"),$("#resetpwd_table :button").click(function(){var uid=$.jqEBMessenger.clientInfo.my_uid,cur_pwd=$.trim($("#resetpwd_table [name='currentPwd']").val()),new_pwd=$.trim($("#resetpwd_table [name='newPass']").val()),repeat_pwd=$.trim($("#resetpwd_table [name='repeatPass']").val());if(0==cur_pwd.length)return void alert("请输入现在的密码");if(0==new_pwd.length)return void alert("请输入新密码");if(0==repeat_pwd.length)return void alert("请再输入一次密码");if(new_pwd!=repeat_pwd)return void alert("新密码不一致，请重新输入");cur_pwd=$.md5(uid+""+cur_pwd).toLowerCase(),new_pwd=$.md5(uid+""+new_pwd).toLowerCase();var params={old_pwd:cur_pwd,passwd:new_pwd};$.ebMsg.sinfo(params,function(data){alert("0"==data.code?"修改成功!":"修改失败: "+data.error),$("#resetpwd_table :password").val("")},function(error){$.im_state.state_handler(error)})})}}})}(window,jQuery);
/*! jqEBMessenger 最后修改于： 2015-08-21 */